---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArrowLink from '../../components/ArrowLink.astro';
import { getPhotoPaths, getPhotoData } from '../../lib/queries';
import { urlFor, getResponsiveProps } from '../../lib/sanity';

export async function getStaticPaths() {
  const slugs = await getPhotoPaths();
  return slugs.map((slug: string) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const photo = await getPhotoData(slug as string);

if (!photo) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found'
  });
}

// Format date if available
const formattedDate = photo.dateTaken 
  ? new Date(photo.dateTaken).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
  : null;

const responsiveParams = getResponsiveProps(photo.image, { 
  width: 1200, 
  aspectRatio: undefined, // Let it be natural? Or is it contain? 
  // Wait, layout says aspect-auto, so natural aspect ratio.
  // getResponsiveProps defaults to 1.5 if undefined. I should update getResponsiveProps or pass undefined?
  // If I pass undefined, it uses 1.5. I should probably allow natural aspect ratio if aspectRatio is undefined.
  // But urlFor needs dimensions or crop.
  // Since we display object-contain in aspect-auto, we usually want natural dimensions.
  // Let's assume landscape 1.5 for now or just force a large width and let height be auto?
  // My getResponsiveProps implements strict aspect ratio cropping.
  // I should probably fix that for Photo page if I want uncropped.
  // For now, I'll use a large 1.5 (3:2) or maybe 4:3?
  // Actually, if I don't pass crop params to urlFor, it returns original aspect ratio. 
  // Let's modify getResponsiveProps to support 'original' aspect ratio.
});
// UPDATE: I will just use a fixed aspect ratio for now (e.g. 1.5) or maybe just pass a large width and let Sanity handle it if I update the helper.
// But refactoring helper affects others. 
// For now, let's keep it simple and just use the existing helper with say 3:2 (1.5) as default. Most photos are 3:2.
// BUT, portrait photos (2:3) will be cropped! That's bad for the Photo page.
// I should update getResponsiveProps to handle 'original' aspect ratio.
---

<BaseLayout title={`${photo.title} | AE.1 Portfolio`}>
  <div class="pt-32 pb-20 px-4 md:px-8 max-w-7xl mx-auto min-h-screen flex flex-col justify-center">
    
    <!-- Navigation Back -->
    <div class="mb-12">
        <a href="/" class="text-xs uppercase tracking-widest opacity-50 hover:opacity-100 transition-opacity">‚Üê Back Home</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-24 items-start">
      
      <!-- Main Image -->
      <div class="lg:col-span-8">
        <div class="aspect-auto bg-gray-100 rounded-lg overflow-hidden shadow-2xl">
          <img 
            src={urlFor(photo.image).width(1600).url()} 
            alt={photo.alt || photo.title}
            class="w-full h-auto object-contain max-h-[85vh]"
          />
        </div>
      </div>

      <!-- Metadata Sidebar -->
      <div class="lg:col-span-4 space-y-12 lg:sticky lg:top-32">
        
        <header>
          <h1 class="text-4xl md:text-5xl font-display mb-6 leading-tight">{photo.title}</h1>
          {photo.caption && (
            <p class="text-muted leading-relaxed text-lg italic border-l-2 border-primary/20 pl-4">{photo.caption}</p>
          )}
        </header>

        <div class="space-y-6 text-sm">
          {photo.location && (
            <div class="flex items-center gap-2">
              <span class="material-icons text-base opacity-50">place</span>
              <span class="uppercase tracking-wider font-medium">{photo.location}</span>
            </div>
          )}
          
          {formattedDate && (
            <div class="flex items-center gap-2">
              <span class="material-icons text-base opacity-50">calendar_today</span>
              <span class="uppercase tracking-wider font-medium">{formattedDate}</span>
            </div>
          )}
          
          {photo.tags && photo.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 pt-4">
              {photo.tags.map((tag: string) => (
                <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-full text-xs uppercase tracking-wide opacity-70">
                  #{tag}
                </span>
              ))}
            </div>
          )}
        </div>

        {photo.relatedCollections && photo.relatedCollections.length > 0 && (
            <div class="pt-8 border-t border-border-color-DEFAULT">
                <span class="text-[10px] uppercase tracking-widest opacity-50 block mb-4">View in Context</span>
                <div class="flex flex-col gap-3">
                    {photo.relatedCollections.map((col: any) => (
                        <ArrowLink href={`/collection/${col.slug}`} label={col.title} />
                    ))}
                </div>
            </div>
        )}

      </div>

    </div>
  </div>
</BaseLayout>
