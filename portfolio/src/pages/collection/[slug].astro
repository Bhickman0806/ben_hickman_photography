---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Lightbox from '../../components/Lightbox.astro'; 
import { getCollectionPaths, getCollectionData } from '../../lib/queries';
import { urlFor, getResponsiveProps } from '../../lib/sanity'; // Added import

export async function getStaticPaths() {
  const slugs = await getCollectionPaths();
  return slugs.map((slug: string) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const collection = await getCollectionData(slug as string);

if (!collection) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found'
  });
}
---

<BaseLayout title={`${collection.title} | Ben Hickman Photography Portfolio`}>
  <div class="pt-32 pb-20 px-4 md:px-8 max-w-7xl mx-auto">
    
    <!-- Collection Header -->
    <header class="mb-20 text-center max-w-3xl mx-auto space-y-6">
      <span class="text-xs uppercase tracking-[0.2em] opacity-60 block">{collection.subtitle || "Collection"}</span>
      <h1 class="text-5xl md:text-7xl font-display leading-tight">{collection.title}</h1>
      {collection.description && (
        <p class="text-muted leading-relaxed max-w-prose mx-auto">{collection.description}</p>
      )}
    </header>

    <!-- Photo Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {collection.photos?.map((photo: any) => {
        const responsive = getResponsiveProps(photo.image, { 
          width: 600, 
          aspectRatio: 4/5, 
          sizes: '(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw' 
        });
        
        return (
        <div 
          class="aspect-[4/5] relative group overflow-hidden bg-gray-100 cursor-pointer"
          data-lightbox
          data-full-src={urlFor(photo.image).width(1600).url()}
          data-caption={`${photo.title}${photo.location ? ` â€” ${photo.location}` : ''}`}
        >
          <img 
            src={responsive.src}
            srcset={responsive.srcset}
            sizes={responsive.sizes} 
            alt={photo.alt || photo.title}
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            loading="lazy"
            decoding="async"
          />
          <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-6">
            <span class="text-white text-xs uppercase tracking-widest font-medium translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
              {photo.title}
            </span>
          </div>
        </div>
      )})}
    </div>

    {!collection.photos && (
      <p class="text-center opacity-50 py-20">No photos in this collection yet.</p>
    )}

  </div>

  <Lightbox />
</BaseLayout>
